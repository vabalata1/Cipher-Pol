<section>
  <h1>Mandats codés</h1>
  <% if (currentUser?.isAdmin) { %>
    <p class="actions"><a class="btn btn-primary" href="/missions/new">Publier une mission</a></p>
  <% } %>

  <form class="filters" method="get" action="/missions">
    <select name="status">
      <option value="">Statut</option>
      <option value="active" <%= (filters && filters.status==='active')?'selected':'' %>>Actif</option>
      <option value="en_cours" <%= (filters && filters.status==='en_cours')?'selected':'' %>>En cours</option>
      <option value="verrouille" <%= (filters && filters.status==='verrouille')?'selected':'' %>>Verrouillé</option>
      <option value="terminee" <%= (filters && filters.status==='terminee')?'selected':'' %>>Terminé</option>
      <option value="archivee" <%= (filters && filters.status==='archivee')?'selected':'' %>>Archivé</option>
    </select>
    <select name="difficulty">
      <option value="">Difficulté</option>
      <option value="faible" <%= (filters && filters.difficulty==='faible')?'selected':'' %>>Faible</option>
      <option value="moyenne" <%= (filters && filters.difficulty==='moyenne')?'selected':'' %>>Moyenne</option>
      <option value="elevee" <%= (filters && filters.difficulty==='elevee')?'selected':'' %>>Élevée</option>
      <option value="critique" <%= (filters && filters.difficulty==='critique')?'selected':'' %>>Critique</option>
    </select>
    <select name="priority">
      <option value="">Priorité</option>
      <option value="basse" <%= (filters && filters.priority==='basse')?'selected':'' %>>Basse</option>
      <option value="normale" <%= (filters && filters.priority==='normale')?'selected':'' %>>Normale</option>
      <option value="haute" <%= (filters && filters.priority==='haute')?'selected':'' %>>Haute</option>
      <option value="critique" <%= (filters && filters.priority==='critique')?'selected':'' %>>Critique</option>
    </select>
    <input name="zone" placeholder="Zone" value="<%= (filters && filters.zone) || '' %>" />
    <select name="sort">
      <option value="">Trier</option>
      <option value="priority" <%= (filters && filters.sort==='priority')?'selected':'' %>>Priorité</option>
      <option value="deadline" <%= (filters && filters.sort==='deadline')?'selected':'' %>>Échéance</option>
    </select>
    <button class="btn btn-outline" type="submit">Filtrer</button>
    <a class="btn btn-secondary push-right" href="/missions">Effacer filtres</a>
  </form>

  <div class="mission-list">
    <% missions.forEach(function(m, i) { 
         const statusKey = (m.status || 'active').toString().toLowerCase();
         const statusLower = statusKey;
         const statusMap = { active: 'Actif', 'en_cours': 'En cours', verrouille: 'Verrouillé', terminee: 'Terminé', archivee: 'Archivé' };
         const statusLabel = statusMap[statusKey] || (statusKey.charAt(0).toUpperCase() + statusKey.slice(1));
    %>
      <article class="mission-card">
        <div class="header">
          <a class="title" href="/missions/<%= m.id %>"><%= m.title %></a>
          <div class="meta-chips">
            <span class="chip chip-status"><%= statusLabel %></span>
            <% if (m.difficulty) { %><span class="chip chip-diff"><%= m.difficulty %></span><% } %>
            <% if (m.priority) { %><span class="chip chip-prio"><%= m.priority %></span><% } %>
            <% if (m.zone) { %><span class="chip chip-zone"><%= m.zone %></span><% } %>
            <% if (m.deadlineAt) { %><span class="chip chip-deadline">Échéance</span><% } %>
          </div>
        </div>
        <% if (m.excerpt) { %>
          <p class="excerpt"><%= m.excerpt %>…</p>
        <% } %>
        <div class="hint">
          <span>#<%= missions.length - i %></span>
        </div>
      </article>
    <% }) %>
  </div>
</section>


