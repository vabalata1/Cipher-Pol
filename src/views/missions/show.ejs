<section>
  <h1>
    <% 
      const statusKey = (mission.status || 'active').toString().toLowerCase();
      const statusMap = { active: 'Actif', 'en_cours': 'En cours', verrouille: 'Verrouillé', terminee: 'Terminé', archivee: 'Archivé' };
      const statusLabel = statusMap[statusKey] || (statusKey.charAt(0).toUpperCase() + statusKey.slice(1));
    %>
    <%= mission.title %>
    <small>
      statut: <%= statusLabel %>
      <% if (mission.difficulty) { %> · difficulté: <%= mission.difficulty %><% } %>
      <% if (mission.priority) { %> · priorité: <%= mission.priority %><% } %>
      <% if (mission.zone) { %> · zone: <%= mission.zone %><% } %>
      <% if (mission.deadlineAt) { %> · échéance: <%= mission.deadlineAt %><% } %>
    </small>

    <% if (currentUser && (currentUser.isAdmin || currentUser.code === 'MR.0' || currentUser.code === 'MR.1')) { %>
      <form style="display:inline-block;margin-left:10px;" method="post" action="/missions/<%= mission.id %>/delete" onsubmit="return confirm('Supprimer cette mission ?');">
        <% if (csrfToken) { %><input type="hidden" name="_csrf" value="<%= csrfToken %>"><% } %>
        <button class="btn btn-outline" type="submit">Supprimer</button>
      </form>
      <form style="display:inline-block;margin-left:10px;" method="post" action="/missions/<%= mission.id %>/status">
        <% if (csrfToken) { %><input type="hidden" name="_csrf" value="<%= csrfToken %>"><% } %>
        <select name="status">
          <option value="active" <%= statusKey==='active' ? 'selected' : '' %>>Actif</option>
          <option value="en_cours" <%= statusKey==='en_cours' ? 'selected' : '' %>>En cours</option>
          <option value="verrouille" <%= statusKey==='verrouille' ? 'selected' : '' %>>Verrouillé</option>
          <option value="terminee" <%= statusKey==='terminee' ? 'selected' : '' %>>Terminé</option>
          <option value="archivee" <%= statusKey==='archivee' ? 'selected' : '' %>>Archivé</option>
        </select>
        <button class="btn btn-secondary" type="submit">Mettre à jour</button>
      </form>
    <% } %>
  </h1>

  <pre class="mission"><%= mission.content %></pre>

  <% if (mission.deadlineAt) { %>
    <div class="hint" id="countdown" data-deadline="<%= mission.deadlineAt %>">T-…</div>
    <script>
      (function(){
        try {
          var el = document.getElementById('countdown');
          if (!el) return; var d = new Date(el.getAttribute('data-deadline')); if (!d) return;
          var tick = function(){
            var now = new Date(); var diff = Math.max(0, d - now);
            var sec = Math.floor(diff/1000); var h = Math.floor(sec/3600); var m = Math.floor((sec%3600)/60); var s = sec%60;
            el.textContent = 'T-' + String(h).padStart(2,'0') + 'h' + String(m).padStart(2,'0') + 'm' + String(s).padStart(2,'0') + 's';
            if (diff<=0) clearInterval(iv);
          };
          tick(); var iv = setInterval(tick, 1000);
        } catch(_){}
      })();
    </script>
  <% } %>



  <div class="meta-chips">
    <span class="chip chip-status"><%= statusLabel %></span>
    <% if (mission.difficulty) { %><span class="chip chip-diff"><%= mission.difficulty %></span><% } %>
    <% if (mission.priority) { %><span class="chip chip-prio"><%= mission.priority %></span><% } %>
    <% if (mission.zone) { %><span class="chip chip-zone"><%= mission.zone %></span><% } %>
    <% if (mission.deadlineAt) { %><span class="chip chip-deadline">Échéance</span><% } %>
  </div>

  <% const isMRAdmin = currentUser && (currentUser.isAdmin || currentUser.code==='MR.0' || currentUser.code==='MR.1'); %>

  <% if ((assignments && assignments.length) || isMRAdmin) { %>
    <h3>Assignations</h3>
    <ul>
      <% (assignments||[]).forEach(a => { %>
        <li><%= a.code %></li>
      <% }) %>
    </ul>
    <% if (isMRAdmin) { %>
      <form class="actions" method="post" action="/missions/<%= mission.id %>/assign">
        <% if (csrfToken) { %><input type="hidden" name="_csrf" value="<%= csrfToken %>"><% } %>
        <input name="code" placeholder="Code agent (ex: MR.7)" required />
        <button class="btn btn-primary" type="submit">Assigner</button>
      </form>
    <% } %>
  <% } %>

  <% if ((binomes && binomes.length) || isMRAdmin) { %>
    <h3>Binômes</h3>
    <ul>
      <% (binomes||[]).forEach(b => { %>
        <li><%= b.codeA %> ↔ <%= b.codeB %></li>
      <% }) %>
    </ul>
    <% if (isMRAdmin) { %>
      <form class="actions" method="post" action="/missions/<%= mission.id %>/binomes">
        <% if (csrfToken) { %><input type="hidden" name="_csrf" value="<%= csrfToken %>"><% } %>
        <input name="codeA" placeholder="Agent A (MR.X)" required />
        <input name="codeB" placeholder="Agent B (MR.X)" required />
        <button class="btn btn-primary" type="submit">Créer binôme</button>
      </form>
    <% } %>
  <% } %>

  <% if ((subs && subs.length) || isMRAdmin) { %>
    <h3>Sous-missions</h3>
    <ul>
      <% (subs||[]).forEach(s => { %>
        <li><a href="/missions/<%= s.id %>"><%= s.title %></a></li>
      <% }) %>
    </ul>
    <% if (isMRAdmin) { %>
      <form class="actions" method="post" action="/missions/<%= mission.id %>/submissions">
        <% if (csrfToken) { %><input type="hidden" name="_csrf" value="<%= csrfToken %>"><% } %>
        <input name="title" placeholder="Titre sous-mission" required />
        <input name="content" placeholder="Brief (optionnel)" />
        <button class="btn btn-primary" type="submit">Créer sous-mission</button>
      </form>
    <% } %>
  <% } %>

  <h2>Réponses</h2>
  <ul>
    <% responses.forEach(r => { %>
      <li><strong><%= r.code %></strong>: <%= r.content %></li>
    <% }) %>
  </ul>
  <form method="post" action="/missions/<%= mission.id %>/respond">
    <% if (csrfToken) { %>
      <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
    <% } %>
    <textarea name="content" rows="4" placeholder="Réponse (codée)…" required></textarea>
    <button type="submit">Envoyer</button>
  </form>
</section>


