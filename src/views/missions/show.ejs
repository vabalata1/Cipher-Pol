<section>
  <h1>
    <% 
      const statusKey = (mission.status || 'active').toString().toLowerCase();
      const statusMap = { active: 'Actif', 'en_cours': 'En cours', verrouille: 'Verrouillé', terminee: 'Terminé', archivee: 'Archivé' };
      const statusLabel = statusMap[statusKey] || (statusKey.charAt(0).toUpperCase() + statusKey.slice(1));
    %>
    <%= mission.title %> <small>(<%= statusLabel %>)</small>
    <% if (currentUser && (currentUser.isAdmin || currentUser.code === 'MR.0' || currentUser.code === 'MR.1')) { %>
      <form style="display:inline-block;margin-left:10px;" method="post" action="/missions/<%= mission.id %>/delete" onsubmit="return confirm('Supprimer cette mission ?');">
        <% if (csrfToken) { %><input type="hidden" name="_csrf" value="<%= csrfToken %>"><% } %>
        <button class="btn btn-outline" type="submit">Supprimer</button>
      </form>
      <form style="display:inline-block;margin-left:10px;" method="post" action="/missions/<%= mission.id %>/status">
        <% if (csrfToken) { %><input type="hidden" name="_csrf" value="<%= csrfToken %>"><% } %>
        <select name="status">
          <option value="active" <%= statusKey==='active' ? 'selected' : '' %>>Actif</option>
          <option value="en_cours" <%= statusKey==='en_cours' ? 'selected' : '' %>>En cours</option>
          <option value="verrouille" <%= statusKey==='verrouille' ? 'selected' : '' %>>Verrouillé</option>
          <option value="terminee" <%= statusKey==='terminee' ? 'selected' : '' %>>Terminé</option>
          <option value="archivee" <%= statusKey==='archivee' ? 'selected' : '' %>>Archivé</option>
        </select>
        <button class="btn btn-secondary" type="submit">Mettre à jour</button>
      </form>
    <% } %>
  </h1>

  <div class="widgets" style="margin:8px 0;">
    <% if (mission.priority) { %><div class="widget"><div class="k">Priorité</div><div class="v"><%= mission.priority %></div></div><% } %>
    <% if (mission.difficulty) { %><div class="widget"><div class="k">Difficulté</div><div class="v"><%= mission.difficulty %></div></div><% } %>
    <% if (mission.zone) { %><div class="widget"><div class="k">Zone</div><div class="v"><%= mission.zone %></div></div><% } %>
    <% if (mission.tags) { %><div class="widget"><div class="k">Tags</div><div class="v"><%= mission.tags.replace(/,/g,' ').trim() %></div></div><% } %>
    <% if (mission.deadlineAt) { %><div class="widget"><div class="k">Échéance</div><div class="v"><%= mission.deadlineAt %></div></div><% } %>
    <% if (votedPriority) { %><div class="widget"><div class="k">Vote MR</div><div class="v"><%= votedPriority %></div></div><% } %>
  </div>

  <div class="actions">
    <a class="btn btn-secondary" href="/missions/<%= mission.id %>/report.pdf" target="_blank">Dossier PDF</a>
  </div>

  <% if (currentUser && (currentUser.code==='MR.0' || currentUser.code==='MR.1')) { %>
    <form class="actions" method="post" action="/missions/<%= mission.id %>/vote">
      <% if (csrfToken) { %><input type="hidden" name="_csrf" value="<%= csrfToken %>"><% } %>
      <select name="value">
        <option value="basse">Basse</option>
        <option value="normale">Normale</option>
        <option value="haute">Haute</option>
        <option value="alpha">ALPHA</option>
      </select>
      <button class="btn btn-outline" type="submit">Voter priorité</button>
    </form>
  <% } %>

  <h3>Jalons</h3>
  <ul>
    <% (milestones||[]).forEach(ms => { %>
      <li>
        <%= ms.title %>
        <% if (ms.dueAt) { %> <small>(due <%= ms.dueAt %>)</small><% } %>
        <% if (!ms.doneAt && currentUser && (currentUser.isAdmin || currentUser.code==='MR.0' || currentUser.code==='MR.1')) { %>
          <form style="display:inline" method="post" action="/missions/<%= mission.id %>/milestones/<%= ms.id %>/done">
            <% if (csrfToken) { %><input type="hidden" name="_csrf" value="<%= csrfToken %>"><% } %>
            <button class="btn btn-outline" type="submit">Marquer fait</button>
          </form>
        <% } else if (ms.doneAt) { %> <small>(fait)</small> <% } %>
      </li>
    <% }) %>
  </ul>
  <% if (currentUser && (currentUser.isAdmin || currentUser.code==='MR.0' || currentUser.code==='MR.1')) { %>
    <form class="actions" method="post" action="/missions/<%= mission.id %>/milestones">
      <% if (csrfToken) { %><input type="hidden" name="_csrf" value="<%= csrfToken %>"><% } %>
      <input name="title" placeholder="Titre du jalon" required />
      <input name="dueAt" placeholder="Échéance (optionnel)" />
      <button class="btn btn-primary" type="submit">Ajouter</button>
    </form>
  <% } %>

  <h3>Assignations</h3>
  <ul>
    <% (assignments||[]).forEach(a => { %>
      <li><%= a.code %></li>
    <% }) %>
  </ul>
  <% if (currentUser && (currentUser.isAdmin || currentUser.code==='MR.0' || currentUser.code==='MR.1')) { %>
    <form class="actions" method="post" action="/missions/<%= mission.id %>/assign">
      <% if (csrfToken) { %><input type="hidden" name="_csrf" value="<%= csrfToken %>"><% } %>
      <input name="code" placeholder="Code agent (ex: MR.7)" required />
      <button class="btn btn-primary" type="submit">Assigner</button>
    </form>
  <% } %>

  <h3>Binômes</h3>
  <ul>
    <% (binomes||[]).forEach(b => { %>
      <li><%= b.codeA %> ↔ <%= b.codeB %></li>
    <% }) %>
  </ul>
  <% if (currentUser && (currentUser.isAdmin || currentUser.code==='MR.0' || currentUser.code==='MR.1')) { %>
    <form class="actions" method="post" action="/missions/<%= mission.id %>/binomes">
      <% if (csrfToken) { %><input type="hidden" name="_csrf" value="<%= csrfToken %>"><% } %>
      <input name="codeA" placeholder="Agent A (MR.X)" required />
      <input name="codeB" placeholder="Agent B (MR.X)" required />
      <button class="btn btn-primary" type="submit">Créer binôme</button>
    </form>
  <% } %>

  <h3>Dépendances</h3>
  <ul>
    <% (deps||[]).forEach(d => { %>
      <li><a href="/missions/<%= d.id %>"><%= d.title %></a></li>
    <% }) %>
  </ul>
  <% if (currentUser && (currentUser.isAdmin || currentUser.code==='MR.0' || currentUser.code==='MR.1')) { %>
    <form class="actions" method="post" action="/missions/<%= mission.id %>/dependencies">
      <% if (csrfToken) { %><input type="hidden" name="_csrf" value="<%= csrfToken %>"><% } %>
      <input name="dependsOnId" placeholder="ID mission dépendance" required />
      <button class="btn btn-primary" type="submit">Ajouter dépendance</button>
    </form>
  <% } %>

  <h3>Sous-missions</h3>
  <ul>
    <% (subs||[]).forEach(s => { %>
      <li><a href="/missions/<%= s.id %>"><%= s.title %></a></li>
    <% }) %>
  </ul>
  <% if (currentUser && (currentUser.isAdmin || currentUser.code==='MR.0' || currentUser.code==='MR.1')) { %>
    <form class="actions" method="post" action="/missions/<%= mission.id %>/submissions">
      <% if (csrfToken) { %><input type="hidden" name="_csrf" value="<%= csrfToken %>"><% } %>
      <input name="title" placeholder="Titre sous-mission" required />
      <input name="content" placeholder="Brief (optionnel)" />
      <button class="btn btn-primary" type="submit">Créer sous-mission</button>
    </form>
  <% } %>

  <% if (mission.deadlineAt) { %>
    <div class="hint" id="countdown" data-deadline="<%= mission.deadlineAt %>">T-…</div>
    <script>
      (function(){
        try {
          var el = document.getElementById('countdown');
          if (!el) return; var d = new Date(el.getAttribute('data-deadline')); if (!d) return;
          var tick = function(){
            var now = new Date(); var diff = Math.max(0, d - now);
            var sec = Math.floor(diff/1000); var h = Math.floor(sec/3600); var m = Math.floor((sec%3600)/60); var s = sec%60;
            el.textContent = 'T-' + String(h).padStart(2,'0') + 'h' + String(m).padStart(2,'0') + 'm' + String(s).padStart(2,'0') + 's';
            if (diff<=0) clearInterval(iv);
          };
          tick(); var iv = setInterval(tick, 1000);
        } catch(_){}
      })();
    </script>
  <% } %>

  <pre class="mission"><%= mission.content %></pre>

  <h2>Réponses</h2>
  <ul>
    <% responses.forEach(r => { %>
      <li><strong><%= r.code %></strong>: <%= r.content %></li>
    <% }) %>
  </ul>
  <form method="post" action="/missions/<%= mission.id %>/respond">
    <% if (csrfToken) { %>
      <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
    <% } %>
    <textarea name="content" rows="4" placeholder="Réponse (codée)…" required></textarea>
    <button type="submit">Envoyer</button>
  </form>
</section>


